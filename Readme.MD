[TOC]

# Lemon framework ä½¿ç”¨æŒ‡å—

## Spring Cloud æ¶æ„å›¾

![image-20190218145236420](doc/image-20190218145236420.png)



## Lemonæ¡†æ¶æ¶æ„å›¾

![image-20190218145650706](doc/image-20190218145650706.png)

##  è§„èŒƒ

+   é™¤æ¥å£å¤–ï¼Œå…¶ä»–å„ä¸šåŠ¡æ¨¡å—ä¸å…è®¸ç›´æ¥ä½¿ç”¨ç¬¬ä¸‰æ–¹jaråŒ…ï¼Œéœ€è¦å°è£…åå†ä½¿ç”¨
+   æ—¥æœŸï¼Œæ—¶é—´ä½¿ç”¨java8æä¾›çš„LocalDateã€LocalDateTimeã€LocalTimeï¼Œlemonæ¡†æ¶å·²æä¾›æ”¯æŒ
+   åœ¨application.yml å¢åŠ ä¸šåŠ¡å‚æ•°ï¼Œå¿…é¡»ä»¥æ¨¡å—åå¼€å¤´. å¦‚ç”¨æˆ·æ¨¡å—ï¼š

```yaml
usr :
  test : testparam
    
```

+   æ§åˆ¶å™¨å±‚Controller, æœåŠ¡å±‚Serviceï¼Œæ•°æ®è®¿é—®å±‚Daoï¼Œä¼ è¾“å¯¹è±¡å‘½åä¸ºDTOï¼ŒæŒä¹…åŒ–å¯¹è±¡DOï¼Œ ä¸šåŠ¡å¯¹è±¡BO
+   Controller ç±»å¿…é¡»ç»§æ‰¿åŸºç±» [BaseController](/lemon-framework/src/main/java/com/cmpay/lemon/framework/controller/BaseController.java)
+   Service ç±»å¿…é¡»ç»§æ‰¿åŸºç±» [BaseService](/lemon-framework/src/main/java/com/cmpay/lemon/framework/service/BaseService.java)
+   Dao ç±»å¿…é¡»ç»§æ‰¿åŸºç±» [BaseDao](/lemon-framework/src/main/java/com/cmpay/lemon/framework/dao/BaseDao.java)
+   DO ç±»å¿…é¡»ç»§æ‰¿åŸºç±» [BaseDO](), ä¸”å¿…é¡»è¢« [@DataObject]() æ³¨è§£
+   BO ç±»ï¼ŒController å±‚è°ƒç”¨Serviceå±‚ä¼ è¾“å¯¹è±¡
+   DTO ç±» [BaseDTO](/lemon-framework/src/main/java/com/cmpay/lemon/framework/data/BaseDTO.java) åŠå…¶å­ç±»[GenericDTO]() å’Œ [GenericRspDTO]()ç±»å‹ï¼Œæ¥å£æ•°æ®å¯¹è±¡çš„ä¼ è¾“ä½¿ç”¨
+   ä»»ä½•æš´éœ²çš„æ¥å£è¿”å›ç±»å‹å¿…é¡»æ˜¯[GenericRspDTO](/lemon-framework/src/main/java/com/cmpay/lemon/framework/data/GenericRspDTO.java)ç±»å‹æˆ–å…¶å­ç±»å‹ï¼Œè¾“å…¥å‚æ•°ä¸­å¿…é¡»ğŸˆ¶ï¸ä¸€ä¸ªå‚æ•°æ˜¯[GenericDTO]()ç±»å‹æˆ–å…¶å­ç±»å‹ï¼Œå»ºè®®å°±ä¸€ä¸ªGenericDTOç±»å‹å‚æ•°
+   æš´éœ²æ¥å£ä»…ä»…åªéœ€è¦è¿”å›æ¶ˆæ¯ç æ—¶ï¼Œè¿”å›å¯¹è±¡åº”å®šä¹‰ä¸º [GenericRspDTO<NoBody>]()
+   Redis ç¼“å­˜çš„ä½¿ç”¨ï¼Œä»»ä½•KEYå¿…é¡»å¸¦å‰ç¼€ï¼Œå¦‚IDç”Ÿæˆå‰ç¼€æ˜¯IDGENï¼Œç¼“å­˜çš„å‰ç¼€æ˜¯CACHEï¼Œç´¯è®¡çš„å‰ç¼€æ˜¯CUMULATIVEï¼›åŸåˆ™ä¸Šä¸å…è®¸ä½¿ç”¨æ¡†æ¶æä¾›ä¹‹å¤–çš„æ–¹æ³•è®¿é—®redisï¼Œå¦‚æœå¿…é¡»ä½¿ç”¨ï¼Œæ³¨å…¥ RedisTemplate å¯¹è±¡
+   javaå¼€å‘è§„èŒƒéµå¾ª[é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ](/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/%E8%A7%84%E8%8C%83%E6%96%87%E6%A1%A3/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4Java%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8Cv1.2.0.pdf)
+   Restful è§„èŒƒéµå¾ª[RESTful_APIè®¾è®¡æŒ‡å—1](/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/%E8%A7%84%E8%8C%83%E6%96%87%E6%A1%A3/RESTful_API%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%971.md)
+   æ‰€æœ‰çš„Feign interface å¼€å‘åªå¼•å…¥ä¸‹é¢çš„åŒ…,é˜²æ­¢ç¬¬ä¸‰æ–¹å¼•å…¥æ¥å£æ—¶åŒ…å†²çª

```gradle
dependencies {
    compile("com.cmpay:lemon-interface")
}
```

---------------------------------------

##  å»ºè®®
+   æš´éœ²æ¥å£è¾“å…¥è¾“å‡ºå‚æ•°ç”¨[GenericDTO](/lemon-framework/src/main/java/com/cmpay/lemon/framework/data/GenericDTO.java) çš„body å±æ€§ä¼ é€’
+   å…ˆè·å–åˆ†å¸ƒå¼é”åå†è°ƒç”¨Serviceå±‚æœåŠ¡ï¼Œé¿å…å› ç­‰å¾…åˆ†å¸ƒå¼é”è€Œé•¿æ—¶é—´å ç”¨æ•°æ®åº“è¿æ¥èµ„æºï¼›è§£å†³æ–¹æ³•è§åˆ†å¸ƒå¼é”

---------------------------------------

##  å·¥å…·ç±»
+   é‡‘é¢è®¡ç®—
    [com.cmpay.lemon.common.Amount](/lemon-common/src/main/java/com/cmpay/lemon/common/Amount.java)

+   æ—¥æœŸã€æ—¶é—´å·¥å…·ç±»
    [com.cmpay.lemon.common.utils.DateTimeUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/DateTimeUtils.java)

+   Bean ç›¸å…³ã€å¦‚å¯¹è±¡å±æ€§æ‹·è´
    [com.cmpay.lemon.common.utils.BeanUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/BeanUtils.java)

+   åˆ¤æ–­ç±»ï¼Œå¦‚äº¤æ˜“è°ƒç”¨æ˜¯å¦æˆåŠŸçš„æ¶ˆæ¯ç åˆ¤æ–­ï¼Œnullã€ç©ºåˆ¤æ–­ç­‰ã€‚
    [com.cmpay.lemon.common.utils.JudgeUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/JudgeUtils.java)

+   validate 
    [com.cmpay.lemon.common.utils.Validate](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/Validate.java)

+   å­—ç¬¦ä¸²æ“ä½œ
    [com.cmpay.lemon.common.utils.StringUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/StringUtils.java)

+   Numberæ“ä½œ
    [com.cmpay.lemon.common.utils.NumberUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/NumberUtils.java)

+   èµ„æºç±»
    [com.cmpay.lemon.common.utils.ResourceUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/ResourceUtils.java)

+   éšæœºæ•°ã€éšæœºå­—ç¬¦ä¸²ã€å›ºå®šé•¿åº¦éšæœºæ•°ã€å›ºå®šé•¿åº¦éšæœºå­—ç¬¦ä¸²
    [com.cmpay.lemon.common.utils.RandomUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/RandomUtils.java)

+   ç±»å¤„ç†ç›¸å…³
    [com.cmpay.lemon.common.utils.ClassUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/ClassUtils.java)
    
+   IOç›¸å…³
    [com.cmpay.lemon.common.utils.IOUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/IOUtils.java)
    
+   åå°„ç›¸å…³
    [com.cmpay.lemon.common.utils.ReflectionUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/ReflectionUtils.java)

+   æ³¨è§£ç›¸å…³
>
>[com.cmpay.lemon.common.utils.AnnotationUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/AnnotationUtils.java)
>
>[com.cmpay.lemon.common.utils.AnnotatedElementUtils](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/AnnotatedElementUtils.java)
>

+   SHA-1/MD5æ¶ˆæ¯æ‘˜è¦çš„å·¥å…·ç±»
    [com.cmpay.lemon.common.security.Digests](/lemon-common/src/main/java/com/cmpay/lemon/common/security/Digests.java)

+   HMAC-SHA1æ¶ˆæ¯ç­¾åã€ DES/AESå¯¹ç§°åŠ å¯†ã€RSAç®—æ³•çš„å·¥å…·ç±»
    [com.cmpay.lemon.common.security.Cryptos](/lemon-common/src/main/java/com/cmpay/lemon/common/security/Cryptos.java)

+   ç¼–ç è§£ç å·¥å…·ç±»(hex/base64/base62/xml escape/html escape/url encoder)
    [com.cmpay.lemon.common.utils.Encodes](/lemon-common/src/main/java/com/cmpay/lemon/common/utils/Encodes.java)

+   å¼‚å¸¸ç±»ï¼ˆRuntime exceptionï¼‰
    [com.cmpay.lemon.common.exception.LemonException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/LemonException.java)
    
+   ä¸šåŠ¡å¼‚å¸¸ç±»
    [com.cmpay.lemon.common.exception.BusinessException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/BusinessException.java)
    
+   ä¸Šä¸‹æ–‡
    [com.cmpay.lemon.common.context.LemonContext](/lemon-common/src/main/java/com/cmpay/lemon/common/context/LemonContext.java)
    
+   IDã€åºåˆ—å·ç”Ÿæˆ
    [com.cmpay.lemon.framework.utils.IdGenUtils](/lemon-framework/src/main/java/com/cmpay/lemon/framework/utils/IdGenUtils.java)

+   æµæ°´å·ã€æ¶ˆæ¯å·ã€ç™»å½•ç”¨æˆ·å·ã€é…ç½®å‚æ•°ã€è®°è´¦æ—¥æœŸ ç­‰å¹³å°ç›¸å…³æ•°æ®
    [com.cmpay.lemon.framework.utils.LemonUtils](/lemon-framework/src/main/java/com/cmpay/lemon/framework/utils/LemonUtils.java)

+   åˆ†é¡µ
    [com.cmpay.lemon.framework.utils.PageUtils](/lemon-framework/src/main/java/com/cmpay/lemon/framework/utils/PageUtils.java)
    
+   DTOå¸¸ç”¨ç±»(cmpay platform)
>
>[com.cmpay.lemon.framework.data.GenericDTO]()
>
>[com.cmpay.lemon.framework.data.GenericRspDTO]()
>
>[com.cmpay.lemon.framework.data.PageableDTO]()
>
>[com.cmpay.lemon.framework.data.PageableRspDTO]()
>
>[com.cmpay.lemon.framework.data.GenericCmdDTO]()
>

---------------------------------------

##  æ—¥å¿—

### åŸºæœ¬ä½¿ç”¨

+   slf4j + logback
+   é…ç½®æ–‡ä»¶: src/main/resource/config/logback-spring.xml
+   Log Level: ERROR, WARN, INFO, DEBUG, or TRACE.
+   ç”Ÿäº§è®¾ç½®æ—¥å¿—çº§åˆ«INFOï¼Œå»ºè®®æµ‹è¯•ç¯å¢ƒè®¾ç½®ä¸ºDEBUG æˆ–ä»¥ä¸‹çº§åˆ«
+   æ—¥å¿—ä½¿ç”¨æ–¹å¼

```java

    public class UserController {
        private static final Logger logger = LoggerFactory.getLogger(UserController.class);
        
        public GenericDTO<NoBody> testException(GenericDTO<NoBody> object) {
            if(logger.isErrorEnabled()) {
                logger.error("throw a exception, message code is {}.", "PRD00001");
            }
            throw BusinessException.create("PRD00001");
        }
    }

```

---------------------------------------

### æ—¥å¿—è„±æ•

- [@Desensitization](/lemon-common/src/main/java/com/cmpay/lemon/framework/desensitization/Desensitization.java)æ³¨è§£

  - [type](/lemon-common/src/main/java/com/cmpay/lemon/framework/desensitization/Type.java) å±æ€§

  | æšä¸¾å€¼       | æè¿°                           |
  | ------------ | ------------------------------ |
  | CHINESE_NAME | ä¸­æ–‡å                         |
  | ID_CARD      | èº«ä»½è¯å·ç                      |
  | PHONE_NO     | ç”µè¯å·ç                        |
  | MOBILE_NO    | æ‰‹æœºå·ç                        |
  | ADDRESS      | åœ°å€ä¿¡æ¯                       |
  | EMAIL        | email                          |
  | BANK_CARD    | é“¶è¡Œå¡å·                       |
  | CNAPS_CODE   | è”è¡Œè¡Œå·                       |
  | LEFT         | å·¦è¾¹è„±æ•                       |
  | MIDDLE       | ä¸­é—´è„±æ•                       |
  | RIGHT        | å³è¾¹è„±æ•                       |
  | ALL          | å…¨éƒ¨è„±æ•                       |
  | SPEL         | spelè¡¨è¾¾å¼, é…åˆ expr å±æ€§ä½¿ç”¨ |
  |              |                                |

  - expr å±æ€§

    >SPELè¡¨è¾¾å¼ï¼Œæ”¯æŒå¦‚ä¸‹æ‰©å±•è¡¨è¾¾å¼

  | æ‰©å±•è¡¨è¾¾å¼ | åŠŸèƒ½             | æè¿°                                                         |
  | ---------- | ---------------- | ------------------------------------------------------------ |
  | SUBSTR     | å­—ç¬¦ä¸²æˆªå–       | å‚æ•°ä¸€ï¼šè¢«å¤„ç†çš„å­—ç¬¦ä¸²<br/>å‚æ•°äºŒï¼šå¼€å§‹ä½ç½®<br/>å‚æ•°ä¸‰ï¼šç»“æŸä½ç½® |
  | SUBSTRE    | å­—ç¬¦ä¸²æˆªå–åˆ°ç»“å°¾ | å‚æ•°ä¸€ï¼šè¢«å¤„ç†çš„å­—ç¬¦ä¸²<br/>å‚æ•°äºŒï¼šå¼€å§‹ä½ç½®                  |
  | STRCAT     | å­—ç¬¦ä¸²æ‹¼æ¥       | å‚æ•°ä¸€ï¼šå­—ç¬¦ä¸²1<br/>å‚æ•°äºŒï¼šå­—ç¬¦ä¸²2                          |
  | STRCAT3    | å­—ç¬¦ä¸²æ‹¼æ¥       | å‚æ•°ä¸€ï¼šå­—ç¬¦ä¸²1<br/>å‚æ•°äºŒï¼šå­—ç¬¦ä¸²2<br/>å‚æ•°ä¸‰ï¼šå­—ç¬¦ä¸²3      |
  | STRCAT4    | å­—ç¬¦ä¸²æ‹¼æ¥       | å‚æ•°ä¸€ï¼šå­—ç¬¦ä¸²1<br/>å‚æ•°äºŒï¼šå­—ç¬¦ä¸²2<br/>å‚æ•°ä¸‰ï¼šå­—ç¬¦ä¸²3<br/>å‚æ•°å››ï¼šå­—ç¬¦ä¸²4 |
  | STRLEN     | å­—ç¬¦ä¸²é•¿åº¦       | å‚æ•°ä¸€ï¼šå­—ç¬¦ä¸²                                               |
  | LEFTPAD    | å·¦å¡«å……           | å‚æ•°ä¸€ï¼šå­—ç¬¦ä¸²<br/>å‚æ•°äºŒï¼šå¡«å……å­—ç¬¦æ•°é‡<br/>å‚æ•°ä¸‰ï¼šå¡«å……å­—ç¬¦ |
  | RIGHTPAD   | å³å¡«å……           | å‚æ•°ä¸€ï¼šå­—ç¬¦ä¸²<br/>å‚æ•°äºŒï¼šå¡«å……å­—ç¬¦æ•°é‡<br/>å‚æ•°ä¸‰ï¼šå¡«å……å­—ç¬¦ |
  |            |                  |                                                              |

- ç¤ºä¾‹

```java

@ApiModel(value="DesensitizationDTO", description="è„±æ•æµ‹è¯•")
public class DesensitizationDTO extends GenericDTO<NoBody>  {

    private String userNo;

    @Desensitization(type = Type.CHINESE_NAME)
    private String userName;

    @Desensitization(type = Type.ID_CARD)
    private String idCard;

    @Desensitization(type = Type.BANK_CARD)
    private String bankNo;

    @Desensitization(type = Type.EMAIL)
    private String email;

    @Desensitization(type = Type.ADDRESS)
    private String address;

    @Desensitization(Type.CNAPS_CODE)
    private String cnapsCode;

    @Desensitization(Type.MOBILE_NO)
    private String mblNo;

    @Desensitization(Type.PHONE_NO)
    private String phoneNo;

    @Desensitization(Type.LEFT)
    private String left;

    @Desensitization(Type.RIGHT)
    private String right;

    @Desensitization(Type.MIDDLE)
    private String middle;

    @Desensitization(expr = "#SUBSTR(#simpleSpel,0,4)")
    private String simpleSpel;

    @Desensitization(expr = "#STRCAT(#RIGHTPAD(#SUBSTR(#nestSpel,0,2),5,\"*\"),#SUBSTRE(#nestSpel,5))")
    private String nestSpel;

    private NestObject nestObject;

    public static class NestObject {
        @Desensitization(Type.CHINESE_NAME)
        private String nestUserName;

        @Desensitization(expr = "#STRCAT(#SUBSTR(#nestObjectSpel,0,2),#LEFTPAD(\"\",8,\"*\"))")
        private String nestObjectSpel;
    }
}

```

- è„±æ•å‰æ•°æ®ï¼š


```json

{
    "userNo" : "123456",
    "userName": "æå°æ˜",
    "idCard" : "430111199910004011",
    "bankNo" :"6225555555554111",
    "email" : "yu_zhou@hisuntech.com",
    "address" : "æ¹–å—çœé•¿æ²™å¸‚åŠ³åŠ¨è¥¿è·¯å˜‰ç››å¥¥ç¾åŸ",
    "cnapsCode" : "308584001024",
    "mblNo" : "13888885009",
    "phoneNo" :  "073182000001",
    "left" : "leftInfo",
    "right" : "rightInfo",
    "middle" : "middleInfo",
    "simpleSpel" : "Simple Spel Test",
    "nestSpel" : "Nest Spel Test",
    "nestObject" : {
    	"nestUserName" : "ææ˜",
    	"nestObjectSpel" : "Nest Object Spel Test"
    }
}


```

- è„±æ•åæ•°æ®ï¼š


```json

{
	"userNo": "123456",
	"userName": "æ**",
	"idCard": "430***********4011",
	"bankNo": "622555******4111",
	"email": "y******@hisuntech.com",
	"address": "æ¹–å—çœé•¿æ²™å¸‚åŠ³åŠ¨è¥¿******",
	"cnapsCode": "30**********",
	"mblNo": "138****5009",
	"phoneNo": "********0001",
	"left": "****Info",
	"right": "righ*****",
	"middle": "m********o",
	"simpleSpel": "Simp",
	"nestSpel": "Ne***Spel Test",
	"nestObject": {
		"nestUserName": "æ*",
		"nestObjectSpel": "Ne********"
	}
}

```

---------------------------------------

### è®¿é—®æ—¥å¿—å±æ€§å¿½ç•¥

- [@LogIgnore](/lemon-framework/lemon-framework-core/src/main/java/com/cmpay/lemon/common/log/LogIgnore.java)æ³¨è§£

  åœ¨DTOçš„å±æ€§å¢åŠ @LogIgnoreï¼Œè®¿é—®æ—¥å¿—ä¸ä¼šæ‰“å°è¯¥å±æ€§

- ç¤ºä¾‹

  ```
  public abstract class BaseLemonData {
      @ResponseIgnore
      @ApiModelProperty(hidden = true)
      @LogIgnore
      private Locale locale;
  }
  ```

### è®¿é—®æ—¥å¿—å…³é”®å­—

> å…³é”®å­—æ˜¯ä¸ºäº†æ–¹ä¾¿æ—¥å¿—æŸ¥è¯¢ã€‚ä¸€æ¡æ—¥å¿—æœ€å¤šå¯ç”¨è®¾ç½®3ä¸ªå…³é”®å­—ï¼Œæœ‰å…¨å±€è®¾ç½®å’Œé€šè¿‡æ³¨è§£æˆ–ä¸Šä¸‹æ–‡ä¸ªæ€§è®¾ç½®ä¸¤ç§æ–¹å¼ã€‚

- #### å…¨å±€è®¾ç½®

```yaml
lemon :
  log :
    keywords : httpSession.mblNo,httpRequest.paramKeywords,httpHeader.headerKeywords,#response?.msgId
```

- #### [@LogKeywords](/lemon-framework/lemon-framework-core/src/main/java/com/cmpay/lemon/common/log/LogKeywords.java) æ³¨è§£

å±æ€§

| å±æ€§å | æè¿°                                                         | é»˜è®¤                                           |
| ------ | ------------------------------------------------------------ | ---------------------------------------------- |
| value  | è·å–å…³é”®å­—è¡¨è¾¾å¼,æ”¯æŒSPELè¡¨è¾¾å¼åŠä»¥ä¸‹æ‰©å±•è¡¨è¾¾å¼ã€‚<br/>**request.XXX **ä»è¯·æ±‚å¯¹è±¡è·å–ï¼›requestå¿…é¡»æŒ‡å®šå‚æ•°ä½ç½®ï¼Œä½ç½®ä»0å¼€å§‹ï¼Œä¾‹å¦‚â€œ"#request[0].userNo"<br/>**response.XXX **ä»å“åº”å¯¹è±¡è·å–<br/>**httpRequest.XXX** ä»HttpServletRequestè·å–<br/>**httpSession.XXX** ä»HttpSessionè·å–<br/>**httpHeader.xxx** ä»http header è·å–<br/> | **æ¸ é“**ï¼šhttpSession.mblNo<br/>**å…¶ä»–**ï¼šnull |

- #### ä¸Šä¸‹æ–‡[LemonContextUtils.addKeywords](/lemon-framework/lemon-framework-core/src/main/java/com/cmpay/lemon/framework/context/LemonContextUtils.java)

- #### ç¤ºä¾‹

  ```java
  @RestController
  @RequestMapping("/user")
  @Api(tags="ç”¨æˆ·äº¤æ˜“")
  public class UserController extends BaseController {
      @Resource
      private IUserService userService;
  
      @ApiOperation(value="æ–°å¢ç”¨æˆ·", notes="æ–°å¢ç”¨æˆ·", produces="application/json")
      @ApiResponse(code = 200, message = "æ–°å¢ç”¨æˆ·ç»“æœ")
      @PostMapping("/openUser")
      @LogKeywords({"#request[0].userNo","#response.msgCd"})
      public GenericRspDTO<NoBody> openUser(@Validated({UsrValidationGroup.OpenUser.class}) @RequestBody UserReqDTO userDTO) {
          this.userService.openUser(BeanUtils.copyPropertiesReturnDest(new UserBO(), userDTO));
          return GenericRspDTO.newSuccessInstance();
      }
  }
  ```



##  å¼‚å¸¸

> å¹³å°æä¾›2ç§ç±»å‹çš„å¼‚å¸¸ï¼Œå¹³å°å¼‚å¸¸[com.cmpay.lemon.common.exception.LemonException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/LemonException.java)å’Œä¸šåŠ¡å¼‚å¸¸[com.cmpay.lemon.common.exception.BusinessException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/BusinessException.java)ã€‚ä¸šåŠ¡å¼‚å¸¸æ˜¯ç”±ä¸šåŠ¡ä»£ç æŠ›å‡ºï¼Œä¸ä¼šæ‰“å°å¼‚å¸¸å †æ ˆä¿¡æ¯ï¼›å¹³å°å¼‚å¸¸æ˜¯å¹³å°è¿è¡Œé”™è¯¯è€ŒæŠ›å‡ºçš„å¼‚å¸¸ï¼Œä¼šåœ¨erroræ—¥å¿—æ‰“å°å †æ ˆä¿¡æ¯ä¾›å¼‚å¸¸å®šä½ã€‚å¹³å°å¯¹å¼‚å¸¸ä¼šåšç»Ÿä¸€å¤„ç†ã€‚

### å¼‚å¸¸ä¸äº‹åŠ¡

1. æŠ›å‡ºå¹³å°å¼‚å¸¸[com.cmpay.lemon.common.exception.LemonException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/LemonException.java)å’Œä¸šåŠ¡å¼‚å¸¸[com.cmpay.lemon.common.exception.BusinessException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/BusinessException.java)ä¼š**å›æ»š**äº‹åŠ¡
2. æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸[com.cmpay.lemon.common.exception.BusinessNoRollbackException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/BusinessNoRollbackException.java)ä¼š**æäº¤**äº‹åŠ¡

### æºå¸¦ä¸šåŠ¡æ•°æ®

ä¸šåŠ¡å¼‚å¸¸[com.cmpay.lemon.common.exception.BusinessException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/BusinessException.java)ã€[com.cmpay.lemon.common.exception.BusinessNoRollbackException](/lemon-common/src/main/java/com/cmpay/lemon/common/exception/BusinessNoRollbackException.java)å®ç°äº†[BusinessObjectCapable](/lemon-common/src/main/java/com/cmpay/lemon/common/BusinessObjectCapable.java)æ¥å£ï¼Œå¯ä»¥æºå¸¦ä¸šåŠ¡æ•°æ®ï¼Œä¸šåŠ¡æ•°æ®ä¼šè‡ªåŠ¨çš„copyåˆ°å“åº”DTOã€‚ä¸šåŠ¡å¯¹è±¡çš„å±æ€§å¿…é¡»å’ŒDTOçš„å±æ€§åç§°å’Œç±»å‹ä¸€è‡´æ‰èƒ½copyæˆåŠŸã€‚

### æºå¸¦æ¶ˆæ¯å‚æ•°

ä¸šåŠ¡å¼‚å¸¸å®ç°äº†[AlertParameterizable](/lemon-common/src/main/java/com/cmpay/lemon/common/AlertParameterizable.java)æ¥å£ï¼Œé”™è¯¯ç msgCdå¯¹åº”çš„æ¶ˆæ¯å¯ä»¥ç”¨å ä½ç¬¦ï¼Œæ¶ˆæ¯ç è§£ææ—¶å¯ä»¥è‡ªåŠ¨è§£æã€‚ä¾‹å¦‚é”™è¯¯ç â€œUSR00001â€å¯¹åº”çš„æ¶ˆæ¯ä¸ºâ€œå½“å‰ä½™é¢å¿…é¡»å¤§äº{1}å…ƒâ€ï¼Œå¼‚å¸¸æŠ›å‡ºå¼‚å¸¸æ–¹å¼å¦‚ä¸‹ï¼š

BusinessException.throwBusinessException(UsrErrorCode.USR00001,"10")

è§£æåçš„é”™è¯¯ä¿¡æ¯ä¸ºâ€œå½“å‰ä½™é¢å¿…é¡»å¤§äº10å…ƒâ€

### ä¸šåŠ¡å¼‚å¸¸æŠ›å‡ºæ–¹å¼

```java
    public GenericDTO<NoBody> testException(GenericDTO<NoBody> object) {
        //BusinessException.throwBusinessException("PRD00001");
        BusinessException.throwBusinessException(ErrorMsgCode.SYS_ERROR);
        return null;
    }

```
### è‡ªå®šä¹‰é”™è¯¯ç 

ä½¿ç”¨enum, å¹¶å®ç°AlertCapableæ¥å£ï¼Œå¦‚å¹³å°é”™è¯¯ç ï¼š

```java

public enum ErrorMsgCode implements AlertCapable {
    SYS_ERROR("SYS00001"),                                      //ç³»ç»Ÿå¼‚å¸¸æ¶ˆæ¯ç 
    ACCESS_DATABASE_ERROR("SYS00002"),                          //è®¿é—®æ•°æ®åº“å¼‚å¸¸
    //.......
    WARNING("SYS11111");                                     //è­¦å‘Šç±»å‹

    private String msgCd;
    private String msgInfo;
    
    /**
     * @param msgCd
     * @param msgInfo
     */
    ErrorMsgCode(String msgCd, String msgInfo) {
        this.msgCd = msgCd;
        this.msgInfo = msgInfo;
    }

    @Override
    public String getMsgCd() {
        return this.msgCd;
    }
    @Override
    public String getMsgInfo() {
        return this.msgInfo;
    }
}

```

### å¹³å°é”™è¯¯ç 

| é”™è¯¯ç    | æè¿°                          | æšä¸¾                            |
| -------- | ----------------------------- | ------------------------------- |
| SYS00001 | ç³»ç»Ÿå¼‚å¸¸                      | SYS_ERROR                       |
| SYS00002 | è®¿é—®æ•°æ®åº“å¼‚å¸¸                | ACCESS_DATABASE_ERROR           |
| SYS00003 | ç­¾åå¼‚å¸¸                      | SIGNATURE_EXCEPTION             |
| SYS00404 | httpè¯·æ±‚æ‰¾ä¸åˆ°å¯¹åº”handler     | NO_HANDLER_FOUND_ERROR          |
| SYS00401 | æ²¡æœ‰è®¤è¯                      | NO_AUTH_ERROR                   |
| SYS01401 | ç”¨æˆ·è®¤è¯è¢«å¼ºåˆ¶è¿‡æœŸï¼ˆå‰”é™¤ï¼‰    | SESSION_EXPIRED                 |
| SYS02401 | æ— æ•ˆçš„refresh token           | REFRESH_TOKEN_INVALID           |
| SYS03401 | è®¤è¯å¤±è´¥                      | AUTHENTICATION_FAILURE          |
| SYS00403 | ç¦æ­¢æ“ä½œ                      | FORBIDDEN_OPERATION             |
| SYS00005 | task schedule exception       | SCHEDULE_TASK_EXCEPTION         |
| SYS00006 | Feignè¯·æ±‚æ‰¾ä¸åˆ°èµ„æº           | SERVER_RESOURCE_NOT_FOUND       |
| SYS00007 | æœåŠ¡ä¸å¯ç”¨ï¼ˆç†”æ–­ï¼‰            | SERVER_NOT_AVAILABLE            |
| SYS00100 | è·å–åˆ†å¸ƒå¼é”å¤±è´¥              | UNABLE_ACQUIRE_DISTRIBUTED_LOCK |
| SYS10001 | Bean validation failure       | BEAN_VALIDATION_ERROR           |
| SYS20000 | Feignè¯·æ±‚å¼‚å¸¸                 | CLIENT_EXCEPTION                |
| SYS20001 | Feignè¯·æ±‚UnknownHostException | CLIENT_EXCEPTION_UNKNOWN_HOST   |
| SYS20002 | å®¢æˆ·ç«¯è¯·æ±‚è¶…æ—¶                | CLIENT_TIMEOUT                  |
| SYS30001 | éæ³•è¯·æ±‚å‚æ•°                  | ILLEGAL_PARAMETER               |
| SYS40001 | Rabbitmqç”Ÿäº§è€…å¼‚å¸¸            | PRODUCER_RABBIT_EXCEPTION       |
| SYS40021 | Rabbitmqæ¶ˆè´¹è€…å¼‚å¸¸            | CONSUMER_RABBIT_EXCEPTION       |
| SYS99999 | ä¸šåŠ¡äº¤æ˜“æ²¡æœ‰é”™è¯¯ç             | MSG_CD_NOT_EXISTS               |
| SYS11111 | è­¦å‘Š                          | WARNING                         |

---------------------------------------

##  æ•°æ®æº

### å•æ•°æ®æº

```yaml

spring :
  datasource :
    type : com.alibaba.druid.pool.DruidDataSource
    url : jdbc:mysql://localhost/test
    username : dbuser
    password : dbpass
    driverClassName : com.mysql.jdbc.Driver

```

###  åŠ¨æ€æ•°æ®æº(å¤šæ•°æ®æº)

+   è§é…ç½®  application.yml

```yaml
lemon :
  #Multiple dataSources
  dataSources :
    primary :
      type : com.alibaba.druid.pool.DruidDataSource
      driverClassName : com.mysql.cj.jdbc.Driver
      url : jdbc:mysql://localhost:3306/seatelpay?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8
      username : seatelpay
      password : seatelpay
    lemon :
      type : com.alibaba.druid.pool.DruidDataSource
      driverClassName : com.mysql.cj.jdbc.Driver
      url : jdbc:mysql://localhost:3306/lemon?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8
      username : lemon
      password : lemon@123
  #dynamic datasource
  dynamicDataSource :
    enabled : true
    defaultDataSource : primary

```

+   åˆ‡æ¢åˆ°éé»˜è®¤æ•°æ®æº, æ³¨è§£ [@com.cmpay.lemon.framework.datasource.TargetDataSource]()

```java
    //åˆ‡æ¢åˆ°lemonæ•°æ®æº
    @Transactional(readOnly=true)
    @TargetDataSource("lemon")
    public MsgInfoDO getMsgInfo(String msgCd, String language) {
        if(JudgeUtils.isBlank(msgCd)) {
            return null;
        }
        if(JudgeUtils.isBlank(language)) {
            if(JudgeUtils.isBlank(this.defaultLanguage)){
                this.defaultLanguage = this.defaultLocale.split("_")[0];
            }
            language = this.defaultLanguage;
        }
        return this.msgInfoDao.getMsgInfo(msgCd, language);
    }
```

---------------------------------------

## IDç”Ÿæˆå™¨

### IDç”Ÿæˆå™¨ç­–ç•¥

```yaml
lemon :
  idgen :
    generator : redisString
```

| ç”Ÿæˆå™¨      | æè¿°                                       | æ˜¯å¦é»˜è®¤ |
| ----------- | ------------------------------------------ | -------- |
| redisString | é‡‡ç”¨redis stringæ•°æ®ç»“æ„å­˜å‚¨id             | æ˜¯       |
| redisHash   | é‡‡ç”¨redis hash æ•°æ®ç»“æ„å­˜å‚¨id              | å¦       |
| simple      | æœ¬åœ°å­˜å‚¨idï¼Œé€‚ç”¨äºå•å®ä¾‹æˆ–å¯ä»¥é‡å¤sequence | å¦       |

### IDé…ç½®

| å±æ€§      | æè¿°           | æ˜¯å¦å¿…é¡»é…ç½® | é»˜è®¤å€¼ |
| --------- | -------------- | ------------ | ------ |
| delta     | idæœ¬åœ°ç¼“å­˜æ•°é‡ | å¦           | 500    |
| max-value | æœ€å¤§å€¼         | æ˜¯           |        |
| min-value | èµ·å§‹å€¼         | å¦           | 1      |

```yaml
lemon :
  idgen :
    delta :
      USER_ID : 1000
    max-value :
      USER_ID : 99999999
    min-value :
      USER_ID : 10000000
```

### IDç”Ÿæˆå™¨API

- IDã€åºåˆ—å·ç”Ÿæˆ
  [com.cmpay.lemon.framework.utils.IdGenUtils](/lemon-framework/src/main/java/com/cmpay/lemon/framework/utils/IdGenUtils.java)

| å¸¸ç”¨API                                     | æè¿°                                      |
| ------------------------------------------- | ----------------------------------------- |
| generateId(String idName)                   | ç”Ÿæˆå®ä¾‹èŒƒå›´å†…å”¯ä¸€sequence                |
| generateId(String idName, String prefix)    | ç”Ÿæˆå®ä¾‹èŒƒå›´å†…å”¯ä¸€å¹¶ä¸”å¸¦å‰ç¼€çš„id          |
| generateId(String idName, int length)       | ç”Ÿæˆå®ä¾‹èŒƒå›´å†…å”¯ä¸€idï¼Œå·¦å¡«å……0ç›´è‡³æŒ‡å®šé•¿åº¦ |
| generateReversedId(String idName)           | ç”Ÿæˆå®ä¾‹èŒƒå›´å†…å”¯ä¸€sequenceï¼Œå¹¶ä¸”åè½¬      |
| generateGlobalId(String idName)             | ç”Ÿæˆå…¨å±€èŒƒå›´å†…å”¯ä¸€sequence                |
| generateGlobalId(String idName, int length) | ç”Ÿæˆå…¨å±€èŒƒå›´å†…å”¯ä¸€idï¼Œå·¦å¡«å……0ç›´è‡³æŒ‡å®šé•¿åº¦ |
| generateReversedGlobalId(String idName)     | ç”Ÿæˆå…¨å±€èŒƒå›´å†…å”¯ä¸€sequenceï¼Œå¹¶ä¸”åè½¬      |
| â€¦...                                        | â€¦...                                      |

###  IDè‡ªåŠ¨ç”Ÿæˆï¼ˆDOï¼‰

- ç¤ºä¾‹

```java
@DataObject
public class UserDO extends BaseDO {
    /**
     * @Fields userId 
     */
    @GeneratedValue(key="USER_ID", prefix="US")
    private String userId;
    
}

```

### è‡ªå®šä¹‰IDç”Ÿæˆç­–ç•¥

* å®šä¹‰IDç”Ÿæˆç­–ç•¥

```java
public class DefaultGeneratorStrategy implements GeneratorStrategy {
    @Override
    public String generatedValue(String key, String prefix) {
        Validate.notBlank(key, "Property \"key\" or \"value\" cloud not be blank in @AutoIdGen");
        if(JudgeUtils.isBlank(prefix)){
            return IdGenUtils.generateCommonId(key);
        }
        return IdGenUtils.generateIdWithShortDate(key, prefix, IdGenUtils.getCommonIdSeqLength());
    }

}
```

* æŒ‡å®šIDç”Ÿæˆç­–ç•¥

```java
@DataObject
public class UserDO extends BaseDO {
    /**
     * @Fields userId 
     */
    @GeneratedValue(key="USER_ID", prefix="US", generatorStrategy=DefaultGeneratorStrategy.class)
    private String userId;
    
}
```

---------------------------------------

##  åˆ†é¡µ

```java

    List<UserDO> userDOs = PageUtils.pageQuery(userQueryDTO.getPageNum(), userQueryDTO.getPageSize(), () -> {
            return this.userService.findUser(queryUserDO);
            });
            

            
    List<UserDO> userDOs = PageUtils.pageQuery(userQueryDTO.getPageNum(), userQueryDTO.getPageSize(), false, () -> {
            return this.userService.findUser(queryUserDO);
            });

    //GenericDTO å®ç°äº†Pageableæ¥å£ï¼Œå¯ä»¥ç›´æ¥ä½œç”¨PageUtils.pageQueryçš„å‚æ•°
    public GenericRspDTO<List<User>> findUsers(@LemonBody UserDTO userDTO) {
        UserBO queryUserBO = new UserBO();
        queryUserBO.setName(userDTO.getName());
        //ä»¥ä¸‹æ˜¯åˆ†é¡µæŸ¥è¯¢
        List<UserBO> userBOs = PageUtils.pageQuery(userDTO, false, () -> this.userService.findUsers(queryUserBO));
        List<User> users = Optional.ofNullable(userBOs).map(s -> s.stream().map(u -> BeanUtils.copyPropertiesReturnDest(new User(), u)).collect(Collectors.toList())).orElse(null);
        return PageableRspDTO.newSuccessNestChildInstance(PageableRspDTO.class, users);
    }

```

---------------------------------------

## äº‹åŠ¡
+   Spring æ³¨è§£äº‹åŠ¡
+   äº‹åŠ¡å¿…é¡»åœ¨Serviceå±‚æ§åˆ¶
+   äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ŒTransactionDefinition.ISOLATION_DEFAULT
+   äº‹åŠ¡ä¼ æ’­è¡Œä¸º
>
>TransactionDefinition.PROPAGATION_REQUIREDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚è¿™æ˜¯é»˜è®¤å€¼ã€‚
>
>TransactionDefinition.PROPAGATION_REQUIRES_NEWï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚
>
>TransactionDefinition.PROPAGATION_SUPPORTSï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚
>
>TransactionDefinition.PROPAGATION_NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚
>
>TransactionDefinition.PROPAGATION_NEVERï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
>
>TransactionDefinition.PROPAGATION_MANDATORYï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
>
>TransactionDefinition.PROPAGATION_NESTEDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡æ¥è¿è¡Œï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¯¥å–å€¼ç­‰ä»·äºTransactionDefinition.PROPAGATION_REQUIREDã€‚
>

+   äº‹åŠ¡è¶…æ—¶ï¼Œé»˜è®¤è®¾ç½®ä¸ºåº•å±‚äº‹åŠ¡ç³»ç»Ÿçš„è¶…æ—¶å€¼
+   springäº‹åŠ¡å›æ»šè§„åˆ™
>
>é»˜è®¤é…ç½®ä¸‹ï¼Œspringåªæœ‰åœ¨æŠ›å‡ºçš„å¼‚å¸¸ä¸ºè¿è¡Œæ—¶uncheckedå¼‚å¸¸æ—¶æ‰å›æ»šè¯¥äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯æŠ›å‡ºçš„å¼‚å¸¸ä¸ºRuntimeExceptionçš„å­ç±»(Errorsä¹Ÿä¼šå¯¼è‡´äº‹åŠ¡å›æ»š)ï¼Œè€ŒæŠ›å‡ºcheckedå¼‚å¸¸åˆ™ä¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šã€‚
>å»ºè®®ä¸šåŠ¡å¼‚å¸¸ä½¿ç”¨LemonException.throwBusinessExceptionæŠ›å‡º
>

+   [@org.springframework.transaction.annotation.Transactional]() çš„å…¶ä»–é…ç½®


```java

@Transactional
@Service
public class UserServiceImpl implements IUserService {
    @Resource
    private UserDao userDao;
    
    @Override
    public void addUser(UserDO userDO) {
        this.userDao.insert(userDO);
    }
    
    @Cacheable(cacheNames="user")
    @Transactional(propagation= Propagation.NOT_SUPPORTED)
    @Override
    public UserDO getUser(String userId) {
        return this.userDao.get(userId);
    }

    @Override
    @Transactional(propagation= Propagation.SUPPORTS, readOnly=true)
    public List<UserDO> findUser(UserDO userDo) {
        return this.userDao.find(userDo);
    }

}


```

---------------------------------------

## ç¼“å­˜
+   å †å†…ç¼“å­˜(Ehcache 3.x)ã€å †å¤–ç¼“å­˜(redis)
+   ehcache3.0 æ˜¯JCache (JSR107) çš„provider

### Redis ç¼“å­˜
+   redis ä¸»è¦ç”¨ä½œåˆ†å¸ƒå¼ç¼“å­˜
+   ç”¨æ³¨è§£[@RedisCacheable]() æ–¹æ³•å³å¯ä»¥å®ç°redisç¼“å­˜æ“ä½œï¼ŒåŸç†æ˜¯ï¼šå…ˆæŸ¥æ‰¾ç¼“å­˜ï¼Œç¼“å­˜æ²¡æœ‰æ•°æ®æ‰§è¡Œæ–¹æ³•å¾—åˆ°æ•°æ®ï¼Œè¿”å›å¾—åˆ°çš„æ•°æ®å¹¶å°†æ•°æ®å­˜å…¥ç¼“å­˜
+   æ³¨è§£@RedisCacheable çš„cacheName å‰ç¼€è®¾ç½® ${lemon.cache.cacheName.prefix}ï¼Œä¸€èˆ¬ä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œæ— éœ€é…ç½®
+   æ”¯æŒSpringåŸç”Ÿæ³¨è§£ @Cacheableã€@CachePutã€@CacheEvictï¼›éœ€è¦å°†cacheResolver æŒ‡å®šä¸º "redisCacheResolver"
+   é»˜è®¤çš„keyGenerator æ˜¯ "CACHE." + simple class name + method name + argsï¼›å¯ä»¥æŒ‰@Cacheable çš„key å±æ€§æŒ‡å®škeyï¼Œä½†key å¿…é¡»å¸¦å‰ç¼€ â€œCACHE.â€ï¼Œ æ”¯æŒSPEL
+   å½“argsä¸ºéåŸå­ç±»å‹åŠå…¶åŒ…è£…ç±»å‹ã€éStringç±»å‹æ—¶ï¼Œå‚æ•°ç±»åº”è¯¥å®ç°CacheKeyParamExtractoræ¥å£
+   åŸåˆ™ä¸Šä¸å…è®¸ç”¨RedisTemplate ç›´æ¥æ“ä½œredis,å¦‚éœ€è¦æ“ä½œï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š


```java
  //å­—ç¬¦ä¸²æ“ä½œ
  @Autowire
  private StringRedisTemplate stringRedisTemplate;

  //å…¶ä»–æ•°æ®ç±»å‹æ“ä½œ
  @Autowire
  private RedisTemplate redisTemplate;

```

+   å¯ä»¥æ ¹æ®ç¼“å­˜åè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¸è®¾ç½®å³ä½¿ç”¨é»˜è®¤çš„è¿‡æœŸæ—¶é—´ï¼š

```yaml

lemon :
  cache :
    jcache :
      config : classpath:config/ehcache3.xml
      provider : org.ehcache.jsr107.EhcacheCachingProvider
    redis :
      database : 0
      host : ${redis.host:192.168.3.39}
      port : 6379
      password : ${redis.password:Hisunpay2017}
      pool :
        #è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
        max-active : 8
        #è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
        max-wait : 10000
        # è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
        max-idle : 8
        # è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
        min-idle : 1
      #è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      timeout : 10000
      #é»˜è®¤ç¼“å­˜è¿‡æœŸæ—¶é—´(ç§’)
      defaultExpiry : 600
      expires :
        USERS : 800
        
```

```java

    @RedisCacheable("USERS")
    @Transactional(readOnly=true)
    @Override
    public UserDO findUser(String userId) {
        return this.userDao.findByUserId(userId);
    }
    
```

### Ehcache3 ç¼“å­˜

+   Ehcache3 ä¸»è¦ç”¨ä½œå †å†…ç¼“å­˜ï¼Œå¦‚æ¶ˆæ¯ç ä¿¡æ¯ç­‰
+   ä½¿ç”¨@JCacheCacheable æ³¨è§£æ–¹æ³•ï¼Œå³å¯ä»¥ä½¿ç”¨ ehcahceç¼“å­˜ï¼ŒåŸç†åŒredis
+   ehcache çš„é…ç½®è§config/ehcache3.xml
+   æ”¯æŒSpringåŸç”Ÿæ³¨è§£ @Cacheableã€@CachePutã€@CacheEvictï¼›éœ€è¦å°†cacheResolver æŒ‡å®šä¸º "jCacheCacheResolver"
+   keyç”Ÿæˆç­–ç•¥åŒredis

```java

    @JCacheCacheable("lemonMsgInfo")
    @Transactional(readOnly=true)
    @TargetDataSource("lemon")
    public MsgInfoDO getMsgInfo(String msgCd, String language) {
        if(JudgeUtils.isBlank(msgCd)) {
            return null;
        }
        if(JudgeUtils.isBlank(language)) {
            if(JudgeUtils.isBlank(this.defaultLanguage)){
                this.defaultLanguage = this.defaultLocale.split("_")[0];
            }
            language = this.defaultLanguage;
        }
        return this.msgInfoDao.getMsgInfo(msgCd, language);
    }
    

```

```xml

    <cache alias="lemonMsgInfo">
	    <expiry>
	      <ttl unit="minutes">5</ttl>
	    </expiry>
	    <heap unit="entries">10000</heap>
	    <heap-store-settings>
	       <max-object-size unit="kB">10</max-object-size>
	    </heap-store-settings>
    </cache>

```

---------------------------------------

## å¹¶å‘

### å¼€å¯å¹¶å‘åŠŸèƒ½

- æ³¨è§£[@EnableConcurrent](/lemon-framework/lemon-framework-concurrent/src/main/java/com/cmpay/lemon/concurrent/EnableConcurrent.java)

```java
@LemonBootApplication
@EnableConcurrent
public class UserApplication {
    public static void main(String[] args) {
        LemonFramework.run(UserApplication.class, args);
    }
}
```



### çº¿ç¨‹æ± 

- åˆ›å»ºçº¿ç¨‹æ± 

æ³¨è§£[@EnableThreadPool](/lemon-framework/lemon-framework-concurrent/src/main/java/com/cmpay/lemon/concurrent/EnableThreadPool.java) åˆ›å»ºçº¿ç¨‹æ± 

| å±æ€§            | å±æ€§å                                                       | æè¿°               | é»˜è®¤å€¼ |
| --------------- | ------------------------------------------------------------ | ------------------ | ------ |
| name            | çº¿ç¨‹æ± åç§°                                                   | çº¿ç¨‹æ± åç§°         |        |
| corePoolSize    | the number of threads to keep in the pool                    | æ”¯æŒspel           | 1      |
| maximumPoolSize | the maximum number of threads to allow in the pool           | æ”¯æŒspel           | 1      |
| keepAliveTime   | when the number of threads is greater than  the core, this is the maximum time that excess idle threads  will wait for new tasks before terminating | æ”¯æŒspelï¼Œå•ä½ï¼šç§’ | 60     |
| queueSize       | the queue to use for holding tasks before they are       executed | æ”¯æŒspel           | 0      |

### å¼‚æ­¥

- åˆ›å»ºçº¿ç¨‹æ± ï¼Œä¸”å°†æ–¹æ³•æäº¤åˆ°çº¿ç¨‹æ± è¿è¡Œ

æ³¨è§£[@AsyncConcurrent](/lemon-framework/lemon-framework-concurrent/src/main/java/com/cmpay/lemon/concurrent/AsyncConcurrent.java)åˆ›å»ºçº¿ç¨‹æ± ï¼Œä¸”è¢«æ³¨è§£çš„æ–¹æ³•å°†åœ¨è¯¥çº¿ç¨‹æ± è¿è¡Œ

| å±æ€§            | å±æ€§å                                                       | æè¿°               | é»˜è®¤å€¼ |
| --------------- | ------------------------------------------------------------ | ------------------ | ------ |
| name            | çº¿ç¨‹æ± åç§°                                                   | çº¿ç¨‹æ± åç§°         |        |
| corePoolSize    | the number of threads to keep in the pool                    | æ”¯æŒspel           | 1      |
| maximumPoolSize | the maximum number of threads to allow in the pool           | æ”¯æŒspel           | 1      |
| keepAliveTime   | when the number of threads is greater than  the core, this is the maximum time that excess idle threads  will wait for new tasks before terminating | æ”¯æŒspelï¼Œå•ä½ï¼šç§’ | 60     |
| queueSize       | the queue to use for holding tasks before they are       executed | æ”¯æŒspel           | 0      |

```java
@Component
public class ConcurrentTest {
    private static final Logger logger = LoggerFactory.getLogger(ConcurrentTest.class);


    @InitialLemonData
    @AsyncConcurrent(name = "ctest", corePoolSize = "2", maximumPoolSize = "${user.threadPool.maxPoolSize:5}")
    public void testConcurrent() {
        logger.info("testConcurrent run in {}, requestId {}", Thread.currentThread().getName(), LemonUtils.getRequestId());
    }

    @InitialLemonData
    @EnableThreadPool(name = "testAsync", corePoolSize = "2", maximumPoolSize = "6")
    @Async(value = "testAsync")
    public void testAsync() {
        logger.info("testAsync run in {}, requestId {}", Thread.currentThread().getName(), LemonUtils.getRequestId());
    }
}
```



-------------------------------------------------------------

##  åˆ†å¸ƒå¼é”

+   ä½¿ç”¨æ³¨è§£@DistributedLockedå®ç°åˆ†å¸ƒå¼é”
  
```java

    @DistributedLocked(lockName = "testLock", leaseTime=40, waitTime=10)
    @Scheduled(fixedRate=10000)
    public void testLock() {
        String str = "testLock1234567890..";
        for(char c : str.toCharArray()) {
            System.out.print(c);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
            }
        }
        System.out.println("");
    }
    
```
+   åˆ†å¸ƒå¼é”ä¸è¦ç”¨åœ¨Serviceå±‚ï¼Œå› ä¸ºè¿™æ ·ä¼šå…ˆè·å–æ•°æ®åº“è¿æ¥ï¼Œå†æ¥ç­‰å¾…åº”ç”¨é”ï¼›å¯ä»¥ç”¨ä¸€ä¸ªéServiceå±‚(æˆ–è€…å«XXæœåŠ¡å±‚)æ–¹æ³•è°ƒç”¨Serviceå±‚æ–¹æ³•ï¼ŒXXæœåŠ¡å±‚æ³¨è§£@DistributedLocked,XXæœåŠ¡å±‚ä¸å«äº‹åŠ¡
+   @DistributedLocked æ³¨è§£è¿˜æœ‰ä¸€äº›å±æ€§ï¼Œè§ä»£ç 
+   å¦‚æœä¸ç”¨æ³¨è§£ï¼Œå¯ä»¥å†™javaä»£ç ä½¿ç”¨åˆ†å¸ƒå¼é”,å¯ä»¥è‡ªå·±æ§åˆ¶å¼‚å¸¸ï¼›å¦‚æœéå¿…é¡»ï¼Œè¿˜æ˜¯ä½¿ç”¨æ³¨è§£

```java

    @Autowired
    private DistributedLocker distributedLocker;

    @Around("@annotation(locked)")
    public void lock(ProceedingJoinPoint pjp, Locked locked) {
        Validate.notEmpty(locked.lockName());
        try {
            distributedLocker.lock(locked.lockName(), locked.leaseTime(), locked.waitTime(), 
            () -> {return proceed(pjp);});
        } catch (UnableToAquireLockException e) {
            if(!(locked.ignoreUnableToAquireLockException() || locked.ignoreException())) {
                LemonException.throwLemonException(e);
            }
            
        } catch (LemonException e) {
            if(! locked.ignoreException()) {
                throw e;
            }
           
        } catch (Throwable e) {
            if(! locked.ignoreException()) {
                LemonException.throwLemonException(e);
            }
           
        }
    }

```

---------------------------------------

## Bean validation JSR303 JSR349

+   feign client bean validate, æ³¨è§£ @com.cmpay.lemon.framework.validation.ClientValidated

```java
cmpay

@ClientValidated
publicom.cmpayserQueryDTO{
    @NotEmpty(message="DM310001")
    private String name;
    
    private Integer pageNum;
    
```
```yaml
åŒæ—¶é…ç½®æ–‡ä»¶éœ€è¦å¼€å¯å®¢æˆ·ç«¯éªŒè¯ï¼š
feign :
  validation :
    enabled : true

```

+   æœåŠ¡ç«¯ mvc æ–¹æ³•çº§åˆ« bean validate, æ³¨è§£@Validated

```java
    //åœ¨controllerå±‚çš„æ–¹æ³•è¾“å…¥å‚æ•°æ³¨è§£ @Validated
    @PostMapping("/addUser")
    public GenericDTO<NoBody> addUser(@Validated @RequestBody UserDTO userDTO) {
        UserDO userDO = new UserDO();
        BeanUtils.copyProperties(userDO, userDTO);
        this.userService.addUser(userDO);
        return GenericDTO.newSuccessInstance();
    }

```

---------------------------------------

##  è½®è¯¢ã€å®šæ—¶ä»»åŠ¡

+   org.springframework.scheduling.annotation.Scheduled
+   å¦‚æœæ˜¯Scheduleç­‰åå°è°ƒèµ·çš„æœåŠ¡ï¼Œå»ºè®®å¿½ç•¥è°ƒæ‰€æœ‰å¼‚å¸¸ï¼Œä¸šåŠ¡æ–¹æ³•é‡Œå¼‚å¸¸ä¸è¦å¾€å¤–æŠ›ï¼ŒæŠ›å‡ºåˆ°çº¿ç¨‹æ± çš„çº¿ç¨‹ä¹Ÿæ²¡æ³•å¤„ç†ã€‚

+   ä¾‹å¦‚ï¼š

```java

    @Scheduled(fixedRateString = "${feign.httpclient.clearConnectionsRate}", initialDelay = 30000)
    public void clearExpiredAndIdleConnections() {
        if(JudgeUtils.isNotNull(poolingHttpClientConnectionManager)) {
            poolingHttpClientConnectionManager.closeExpiredConnections();
            poolingHttpClientConnectionManager.closeIdleConnections(feignHttpclientProperties.getIdleTimeoutMillis(), TimeUnit.MILLISECONDS);
        }
    }
    
      
```

+   çº¿ç¨‹æ± é…ç½®

```yaml

lemon :
  schedule :
    threadPool :
      poolSize : 10
      waitForTasksToCompleteOnShutdown : true
      awaitTerminationSeconds : 30
      
```

+   æ–¹æ³•è°ƒç”¨å‰`ä¸ä¼š`åˆå§‹åŒ–LemonDataï¼›é…ç½®åˆå§‹åŒ–æ–¹å¼å¦‚ä¸‹:

```java

    @Scheduled(fixedRate=5000)
    @InitialLemonData("backgroundLemonDataInitializer")
    public void testInitialLemonData() {
        //test....
    }
    
```

---------------------------------------

##  æ‰¹å¤„ç†

+   com.cmpay.lemon.framework.schedule.batch.BatchScheduledï¼Œ æ³¨è§£å‚æ•°åŒ@Scheduled

+ ç¤ºä¾‹

```java

    @BatchScheduled(fixedRate=10000)
    public void schedule() {
        System.out.println("@BatchScheduled test..................");
    }
    
```

+   çº¿ç¨‹æ± é…ç½®åŒ â€œè½®è¯¢ã€å®šæ—¶ä»»åŠ¡â€

+   æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼Œ@Schedule ä¸ä¼šå¤„ç†

+   æ‰¹å¤„ç†æ¨¡å¼ä¸‹ï¼ŒMQæ¶ˆè´¹è€…é»˜è®¤ä¸ä¼šå¯åŠ¨ï¼› é€šè¿‡ä¸‹é¢é…ç½®å¯ä»¥å¼€å¯MQæ¶ˆè´¹è€…
```yaml
spring :
  cloud :
    stream :
      bindings :
        input :
          consumer :
            enabled : true
            batchEnabled : true
```

+   å¼€å¯æ‰¹å¤„ç†æ¨¡å¼,é»˜è®¤æœªå¼€å¯

>
>   æ–¹å¼ä¸€ï¼š
>
>   javaå‚æ•°å½¢å¼"-Dlemon.batch.enabled=true"
>
>   æ–¹å¼äºŒï¼š
>
>   ymlé…ç½® "lemon.batch.enabled=true"
>

+   æ–¹æ³•è°ƒç”¨å‰ä¼šè‡ªåŠ¨åˆå§‹åŒ–LemonDataï¼Œå¯ä»¥ä»LemonUtilsè·å–

---------------------------------------

##  å›½é™…åŒ–

+   æ¶ˆæ¯ç å·²æä¾›æ”¯æŒï¼Œæ¶ˆæ¯ç è¡¨ï¼šlemon.lemon_msg_info
+   com.cmpay.lemon.framework.i18n.LocaleMessageSourceï¼Œè¯¥ç±»åœ¨BaseController å·²æ³¨å…¥ï¼Œè¯»å–é…com.cmpay/message.properties**
+   ç³»ç»Ÿå–ä¸åˆ°åŒºåŸŸä¿¡æ¯ã€æˆ–åŒºåŸŸä¿¡æ¯ä¸åœ¨å¹³å°è¯†åˆ«çš„èŒƒå›´ç±»æ˜¯ï¼Œé»˜è®¤çš„åŒºåŸŸé…ç½®

```yaml
lemon:
  locale :
    default : zh_cn
```

---------------------------------------

##  å¼‚æ­¥åŠè®¢é˜…å‘å¸ƒ

+   spring cloud stream rabbit å®ç°

+   é…ç½®æ–‡ä»¶

```yaml

spring :
  cloud :
    stream :
      defaultBinder : rabbit
      binders :
        rabbit :
          type : rabbit
          environment :
            spring :
              rabbitmq :
                addresses : stream
                virtualHost : /lemon
                username : stream
                password : stream
                requestedHeartbeat : 10
                publisherConfirms : true
                publisherReturns : true
                connectionTimeout : 10000
                cache:
                  channel :
                    size : 5
      bindings :
        input :
          destination : ${spring.application.name}
          group : ${spring.application.name}
          consumer :
            enabled : true
            concurrency : 1
            maxConcurrency : 5
            maxAttempts : 1
            durableSubscription : true
            prefetch : 10
            txSize : 10
        #channel
        output :
          enabled : true
          #binder topic
          destination : SCM
        output1 :
          enabled : false
          destination : PRD

```

+   ç”Ÿäº§è€…ï¼ˆè®¢é˜…å‘å¸ƒçš„å‘å¸ƒè€…ï¼‰

```java
//æ¡†æ¶ä¼šè‡ªåŠ¨å°†æ–¹æ³•çš„è¿”å›å¯¹è±¡ï¼ˆå³ä¸»é¢˜ã€Helloå¯¹è±¡ï¼‰é€šè¿‡é€šé“ï¼ˆchannelNameï¼‰å‘é€å‡ºå»
@Component
public class TestProducer {
    @Producers({
        @Producer(beanName="helloMessageHandler", channelName=MultiOutput.OUTPUT_DEFAULT),          //beanName ä¸ºæ¶ˆè´¹ä¸»é¢˜(Hello)çš„spring bean name
        @Producer(beanName="helloMessageHandler2", channelName=MultiOutput.OUTPUT_DEFAULT)          //channelName ä¸ºå°†ä¸»é¢˜å‘é€å‡ºå»çš„é€šé“åï¼Œå¦‚é…ç½®æ–‡ä»¶ä¸­çš„output
    })
    public Hello sendHello() {
        return new Hello("hello-->",40);
    }
}

//ç³»ç»Ÿé»˜è®¤å¯ä»¥å¯åŠ¨8ä¸ªé€šé“
    public static final String OUTPUT_DEFAULT = "output";
    public static final String OUTPUT_ONE = "output1";
    public static final String OUTPUT_TWO = "output2";
    public static final String OUTPUT_THREE = "output3";
    public static final String OUTPUT_FOUR = "output4";
    public static final String OUTPUT_FIVE = "output5";
    public static final String OUTPUT_SIX = "output6";
    public static final String OUTPUT_SEVEN = "output7";

```

+   æ¶ˆè´¹è€…(è®¢é˜…å‘å¸ƒä¸­çš„è®¢é˜…è€…)ï¼Œæ¡†æ¶é»˜è®¤é…ç½®ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹inputé€šé“

+   æ¶ˆè´¹è€…ä¸­çš„spring bean å¿…é¡»å®ç° com.cmpay.lemon.framework.stream.MessageHandler æ¥å£

```java

@Component("helloMessageHandler")
public class HelloMessageHandler implements MessageHandler<Hello> {
    private static final Logger logger = LoggerFactory.getLogger(HelloMessageHandler.class);
    
    @Override
    public void onMessageReceive(GenericCmdDTO<Hello> genericCmdDTO) {
        logger.info("Receive msg hand {}", genericCmdDTO.getBody());
    }
}

```
### å¼‚æ­¥

#### å¼‚æ­¥æ¥å£è°ƒç”¨ï¼Œç”±æ¶ˆè´¹ç«¯æä¾›æ¥å£

æ¥å£å®šä¹‰ç¤ºä¾‹å¦‚ä¸‹

```java

@StreamClient("usr")
public interface OperDetailClient {
    @Source(handlerBeanName = "operDetailHandler", output = "usr", group = "usr", prefix = "mirror.")
    void saveUserOperDetail(UserOperDetailBO userOperDetailBO);
}

```
#### æ³¨è§£è¯´æ˜

+ StreamClient æŒ‡å®šè¯¥æ¥å£ä¸ºå¼‚æ­¥æ¥å£

> value : æŒ‡å®šè¯¥æ¥å£é»˜è®¤çš„ binding name 

+ Source æŒ‡å®šè¯¥æ–¹æ³•ä¸ºå¼‚æ­¥è°ƒç”¨

> handlerBeanName : æ¶ˆè´¹è€…spring bean name

> output : binging name ï¼Œå»ºè®®é…ç½®æˆæ¶ˆè´¹è€…å®ä¾‹å

> group : æ¶ˆè´¹è€…groupï¼Œå»ºè®®é…ç½®æˆæ¶ˆè´¹è€…å®ä¾‹åï¼Œé…ç½®äº†è¯¥å‚æ•°å¯ä»¥è‡ªåŠ¨åˆ›å»ºexchange, queue, binding, å¦åˆ™ä¾èµ–æ¶ˆè´¹è€…åˆ›å»º

> prefix : exchange name å’Œ queue name çš„å‰ç¼€, å¦‚æœrabbit mq broken å»ºè®®é…ç½®æˆ"mirror.", 

+ å…¶ä»–ç‰¹æ®Šé…ç½®åªèƒ½é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®(ä¸æ¨è)ï¼Œä¾‹å¦‚

```yaml

spring :
  cloud :
    stream :
      bindings :
        usr :
          destination : usr #@Source æ³¨è§£ä¸­è·Ÿoutput å±æ€§å€¼ä¸€è‡´
          producer :
            requiredGroups : usr
      rabbit :
        bindings :
          usr :
            producer :
              prefix : mirror.
```

---------------------------------------

##  ä¼šè¯(Session)

### starter

```gradle

compile("com.cmpay:lemon-framework-starter-session")

```

### æ”¯æŒCookie å’Œ headeræ–¹å¼ä¼ é€’sessionId

+ cookie name é»˜è®¤ä¸º"sid"

+ header name é»˜è®¤ä¸º"x-auth-token"

+ SessionId ä¼ é€’æ–¹å¼

  | SessionId Strategy | è¯´æ˜                                                  | æ˜¯å¦é»˜è®¤å€¼ |
  | ------------------ | ----------------------------------------------------- | ---------- |
  | Cookie             | ä½¿ç”¨cookie ä¼ é€’sessionId                              | N          |
  | Header             | ä½¿ç”¨Http Header ä¼ é€’sessionId                         | N          |
  | CookieOrHeader     | ä¼˜å…ˆä½¿ç”¨Cookieï¼ŒCookie ä¸å­˜åœ¨åˆ™ä½¿ç”¨Http Headerï¼›      | N          |
  | HeaderOrCookie     | ä¼˜å…ˆä½¿ç”¨Http Headerï¼Œ Http Header ä¸å­˜åœ¨åˆ™ä½¿ç”¨Cookie; | Y          |

+ API Gateway ä¼šå°†sessionIdæ”¾http headerå‘é€åˆ°æ¸ é“å±‚åº”ç”¨ï¼Œæ‰€ä»¥SessionIdä¼ é€’æ–¹å¼è®¾ç½®ä¸ºHeaderOrCookieæ—¶ï¼ŒsessionIdæ€»æ˜¯èƒ½ä»http headerè·å–å¾—åˆ°ã€‚è®¤è¯äº¤æ˜“å¦‚æœéœ€è¦å°†sessionIdå†™å…¥cookieæ—¶ï¼Œéœ€è¦é…ç½®lemon.session.sessionId.forceCreatingCookieOnNewSession=true,å¹¶ä¸”åœ¨API ç½‘å…³çš„è®¤è¯äº¤æ˜“é…ç½® (*è®¤è¯äº¤æ˜“ä¸ºcon-login*) zuul.routes.con-login.sensitiveHeaders=Cookie,Authorization,X-Forwarded-Forï¼ˆ*è¦†ç›–zuul.sensitiveHeadersé…ç½®ä¸­çš„Set-Cookie*ï¼‰

+ zuul.sensitiveHeaderså¦‚æœé…ç½®æœ‰Cookieï¼Œé‚£ä¹ˆsessionIdä¸èƒ½ç”±cookieä¼ é€’åˆ°æ¸ é“å±‚åº”ç”¨(*æ‰€æœ‰cookieéƒ½ä¸èƒ½å¾€ä¸‹æ¸¸ä¼ é€’*)

+ zuul.sensitiveHeaderå¦‚æœé…ç½®æœ‰Set-Cookieï¼Œé‚£ä¹ˆsessionIdé»˜è®¤æƒ…å†µä¸‹ä¸èƒ½å†™å…¥cookieï¼›é™¤éAPI Gatewayå¯¹åº”äº¤æ˜“å¢åŠ é…ç½®zuul.routes.con-login.sensitiveHeadersè¦†ç›–æ‰zuul.sensitiveHeader

+ æ›´æ”¹é»˜è®¤é…ç½®

```yaml
lemon :
  session :
    sessionId :
      cookie : 
        cookieName : sid
        domain : cmpay.com
        maxAge : -1
        cookiePath : /
      headerName : x-auth-token
      strategy : HeaderOrCookie
```
---------------------------------------

##  è®¤è¯

### security starter

```gradle

compile("com.cmpay:lemon-framework-starter-security")

```

### refresh starter (ä¸éœ€è¦æ­¤åŠŸèƒ½çš„ä¸è¦å¼•å…¥è¯¥starter)
```gradle

compile("com.cmpay:lemon-framework-starter-security-refresh")

```

#### è®¤è¯å¼€å‘ç¤ºä¾‹
[MockUserNamePasswordMatchableAuthenticationProcessor](/lemon-framework/lemon-framework-security/src/main/java/com/cmpay/lemon/framework/security/auth/MockUserNamePasswordMatchableAuthenticationProcessor.java)

+ ç»§æ‰¿æŠ½è±¡ç±» [AbstractGenericMatchableAuthenticationProcessor](/lemon-framework/lemon-framework-security/src/main/java/com/cmpay/lemon/framework/security/auth/AbstractGenericMatchableAuthenticationProcessor.java), æ„é€ æ–¹æ³•å‚æ•°"filterProcessesUrl"å‰ç¼€å¿…é¡»ä¸"lemon.security.authentication.loginPathPrefix"ä¸€è‡´


#### refreshå¼€å‘ç¤ºä¾‹
```java
    public static final String BEAN_NAME_REFRESH_TOKEN_AUTHENTICATION_PROCESSOR = "refreshTokenAuthenticationProcessor";

    @Bean
    @ConditionalOnMissingBean(name = BEAN_NAME_REFRESH_TOKEN_AUTHENTICATION_PROCESSOR)
    public AuthenticationProcessor refreshTokenAuthenticationProcessor() {
        return authentication -> new SimpleUserInfo("mock123456", "mock", "12345678900");
    }
```

#### ç™»å‡º

+ è®¾ç½®header  x-auth-token
+ è¯·æ±‚URL /security/logout
+ ç™»å‡ºæ—¶éœ€è¦åˆ é™¤cookieä¸­çš„sessionIdï¼Œéœ€é…ç½®lemon.security.logout.clearingCookieSessionId=trueï¼Œé»˜è®¤ä¸ºfalse

#### é…ç½®

```yaml
lemon :
  security :
    authentication :
      loginPathPrefix : /consumer/security/login  #é»˜è®¤ /security/login
      refreshPath : /consumer/security/refresh    #é»˜è®¤ /security/refresh
      logoutPath : /consumer/security/logout      #é»˜è®¤ /security/logout
    authorizeRequests :
      #é…ç½®ä¸è¿›è¡Œè®¤è¯æ£€æŸ¥çš„äº¤æ˜“è¯·æ±‚url
      permitAll :
#        - /consumer/openUser
        - /consumer/findUsers
        
```

---------------------------------------

## XSS

```groovy
dependencies {
    compile ("com.cmpay:lemon-framework-starter-xss")
}
```

æˆ–è€…å¼•å…¥æ¸ é“ä¾èµ–

```
dependencies {
    compile("com.cmpay:lemon-entry-point-starter")
}
```

---------------------------------------

##  éšæœºæ•°

+   ç¤ºä¾‹

```java

    @Resource("bindingTokenRandomTemplate")
    private RandomTemplate randomTemplate;
    
    @GetMapping("/testRandomTemplate")
    public GenericRspDTO<NoBody> testRandomTemplate() {
        String random = randomTemplate.apply("Test", 30*60*1000, RandomType.NUMERIC_LETTER, 15);
        logger.info("random is {}", random);
        randomTemplate.validateOnce("Test", random);
        return GenericRspDTO.newSuccessInstance();
    }

```

+   å…·ä½“è§æ¥å£ [com.cmpay.lemon.framework.random.RandomTemplate]()

+   å®ç°ç±»com.cmpay.lemon.redis.random.BindingTokenRandomTemplate; ä¸ç”¨æˆ·sessionIdç»‘å®š

---------------------------------------

##  æ—¥ç´¯è®¡ã€æœˆç´¯è®¡

+   åˆ©ç”¨rediså®ç°
+   æ¥å£Cumulative å®ç°äº†æ—¥ç´¯è®¡ã€æœˆç´¯è®¡ã€ æ—¥æœˆç´¯è®¡ã€æ—¥ç´¯è®¡æŸ¥è¯¢ã€æœˆç´¯è®¡æŸ¥è¯¢
+   æ”¯æŒå¤šç»´åº¦çš„ç´¯è®¡; new Dimension("K1","1") å¯¹è±¡ï¼ŒK1 è¡¨ç¤ºç»´åº¦ã€â€œ1â€ è¡¨ç¤ºç´¯è®¡å€¼ï¼Œå¯ä»¥åŒæ—¶è®¾ç½®å¤šä¸ªç»´åº¦
+   æ—¥ç´¯è®¡ã€æœˆç´¯è®¡ã€ æ—¥æœˆç´¯è®¡ ä½¿ç”¨LUA è„šæœ¬å®ç°ï¼ŒåŸå­æ€§æ“ä½œ
+   ä½¿ç”¨æ–¹æ³•è§ä¸‹é¢ä¾‹å­

```java
   
    @Autowired
    private Cumulative cumulative;

    @GetMapping("/testCumulative/{mode}")
    public GenericDTO<NoBody> testCumulative(@PathVariable String mode) {
        if(JudgeUtils.equals(mode, "0")) {
            this.cumulative.countByDay("TEST", new Dimension("K1","1"),new Dimension("K2","2"),new Dimension("K3","3"));
        } else if (JudgeUtils.equals(mode, "1")) {
            this.cumulative.countByMonth("TEST", new Dimension("K1","1"),new Dimension("K2","2"),new Dimension("K3","3"));
        } else if(JudgeUtils.equals(mode, "2")) {
            this.cumulative.countByDayAndMonth("TEST", new Dimension("K1","1"),new Dimension("K2","2"),new Dimension("K3","3"));
        }
        return GenericDTO.newSuccessInstance();
    }
    
    @GetMapping("/queryCumulative/{mode}/{dimension}")
    public GenericDTO<String> testCumulative(@PathVariable String mode, @PathVariable String dimension) {
        String rst = "";
        if(JudgeUtils.equals(mode, "0")) {
           rst = this.cumulative.queryByDay("TEST", dimension);
        } else if (JudgeUtils.equals(mode, "1")) {
           rst = this.cumulative.queryByMonth("TEST", dimension);
        }
        return GenericDTO.newSuccessInstance(rst);
    }

```
---------------------------------------

## lemon framework starter 

| starter                                                      | åŠŸèƒ½æè¿°                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| compile("com.cmpay:lemon-framework-starter-cloud")           | æ”¯æŒspring cloudçš„lemon framework                            |
| compile("com.cmpay:lemon-framework-starter-stream")          | rabbitmq/kafkaæ”¯æŒ                                           |
| compile("com.cmpay:lemon-framework-starter-session")         | åˆ†å¸ƒå¼session                                                |
| compile("com.cmpay:lemon-framework-starter-security")        | è®¤è¯ã€æˆæƒã€spring securityå°è£…                              |
| compile("com.cmpay:lemon-framework-starter-security-refresh") | refresh tokenæ”¯æŒã€å®¢æˆ·ç«¯ç™»å½•ä¿æŒ                            |
| compile("com.cmpay:lemon-swagger-starter")                   | swaggeræ”¯æŒ                                                  |
| compile("org.springframework.cloud:spring-cloud-starter-config") | config server                                                |
| compile("com.cmpay:lemon-entry-point-starter")               | æ¸ é“åº”ç”¨ï¼›åŒ…æ‹¬æ¸ é“åº”ç”¨ç‰¹æ€§åŠä»¥ä¸‹starter <br/>compile project(":lemon-framework:lemon-framework-starter-xss")<br/>compile project(":lemon-framework:lemon-framework-starter-security")   <br/>compile project(":lemon-framework:lemon-framework-starter-session") |
| compile("com.cmpay:lemon-framework-starter-xss")             | xss                                                          |

##  åº”ç”¨ç»´æŠ¤

+ å¯åŠ¨æœåŠ¡, è¿è¡Œè„šæœ¬start.sh

    > å¯åŠ¨JVM,åº”ç”¨æœåŠ¡å™¨,åº”ç”¨å…·å¤‡æ¥æ”¶ä¸€åˆ‡è¯·æ±‚çš„èƒ½åŠ›
+ åœæ­¢æœåŠ¡, è¿è¡Œè„šæœ¬stop.sh

    > åœæ­¢JVM
+ ä¸‹çº¿æœåŠ¡, è¿è¡Œè„šæœ¬offline.sh

    > æ³¨å†Œä¸­å¿ƒä¸‹çº¿æœåŠ¡ï¼Œåº”ç”¨è¿˜å…·å¤‡æ¥æ”¶è¯·æ±‚çš„èƒ½åŠ›

---------------------------------------

##  ç¼–è¯‘ã€æ‰“åŒ…ã€å¯åŠ¨æœåŠ¡

+   è¿è¡Œgradle å‘½ä»¤ï¼š gradle clean build dist æˆ–è€… lemonæ’ä»¶dist
+   åœ¨å·¥ç¨‹ç›®å½•ä¸‹çš„build/targetçš„ç›®å½•ä¸‹ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶åŠæ–‡ä»¶å¤¹

>   bin
>
>   lemon-prd-1.0.0-SNAPSHOT.jar
>
>   è¿è¡Œbin/start.sh å³å¯ä»¥å¯åŠ¨æœåŠ¡

+   åœ¨å·¥ç¨‹ç›®å½•ä¸‹çš„build/distributionsç›®å½•ä¸‹ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶

>
>   lemon-prd-1.0.0-SNAPSHOT.zip
>
>   æŠŠæ­¤zipæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨è§£å‹å¯ä»¥å¾—åˆ°build/targetçš„ç›®å½•ç»“æ„

---------------------------------------

##  é€šé“

+   é¡¹ç›®å¼•å…¥é€šé“æ¡†æ¶

```gradle

    compile("com.cmpay:channel-integration-starter:1.0.0-SNAPSHOT")

```

+   å¼•å…¥è‡ªå·±å¼€å‘çš„é€šé“é¡¹ç›®com.cmpay:channel-cmsb

```gradle

    compile("com.cmpay:channel-cmsb:1.0.0-SNAPSHOT")
    compile("com.cmpay:channel-cgb:1com.cmpaySHOT")

```

+   é€šé“å¼€å‘è¯¦æƒ…è§ [ã€Šé€šé“å¼€å‘æŒ‡å—.docxã€‹](httcom.cmpay6.22.56/microservices-platform/channel/blob/master/%E9%80%9A%E9%81%93%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97.docx)
  
>
>   ä¿®æ”¹ï¼š
>â€‹    1ï¼Œ å„å­é€šé“é…ç½®æ–‡ä»¶ä¸éœ€è¦åœ¨config/channel-spring.xmlæ–‡ä»¶ä¸­import, é…ç½®æ–‡ä»¶å‘½åè§„åˆ™æ”¹ä¸ºâ€œé¡¹ç›®å-channel-spring.xmlâ€
>â€‹    

+   å®¢æˆ·ç«¯ä»£ç 

```java

    
    @Autowired
    private IChannelClient channelClient;
    
    @GetMapping("/testChannel")
    public GenericRspDTO<?> testChannel(GenericDTO<NoBody> genericDTO) {
        LocalDateTime localDate = LocalDateTime.now();
        DateTimeFormatter formatterDate = DateTimeFormatter.ofPattern("yyyyMMdd");
        DateTimeFormatter formatterTime = DateTimeFormatter.ofPattern("HHmmss");
        PayReq.TranReq tranReq = new PayReq.TranReq();
        tranReq.setMchntCd("MCH0000000000001");
        tranReq.setTranDate(localDate.format(formatterDate));
        tranReq.setTranTime(localDate.format(formatterTime));
        tranReq.setTranId("1602061010000000");
        tranReq.setCurrency("RMB");
        tranReq.setPayAcctNo("PAYACCNO0000002");
        tranReq.setPayAccName("yuzhou");
        tranReq.setPayBankType("1");
        tranReq.setPayBankName("ä¸­å›½é“¶è¡Œ");
        tranReq.setAccNo("6226192914678983");
        tranReq.setAccName("YUZHOU");
        tranReq.setBankType("105100000017");
        tranReq.setBankName("æ‹›è¡Œ");
        tranReq.setTransAmt(new BigDecimal("99.99"));
        tranReq.setRemarkCd("90804");
        tranReq.setRemark("case115");
        tranReq.setResv("case115");
        
        PayReq payReq = new PayReq();
        payReq.setCooperationCd("1000000000001");
        payReq.setTxCd("3002");
        payReq.setTranReq(tranReq);
        
        Request request = new Request();
        request.setRoute("CMSB");
        request.setBusiType("pay");
        request.setSource("tst");
        request.setTarget(payReq);
        request.setRequestId(genericDTO.getMsgId());
        Response response = channelClient.request(request);
        logger.info("channel rsp code {}", response.getMsgCode());
        logger.info("channel rsp info {}", response.getMsgInfo());
        logger.info("channel rsp object {}", response.getResult());
        return GenericRspDTO.newInstance(response.getMsgCode(), response.getResult());
    }

```

---------------------------------------

##  è¸©è¿‡çš„å‘
+   ribbon é»˜è®¤ä¼šå¯¹è¶…æ—¶çš„GETè¯·æ±‚retryä¸€æ¬¡ã€‚åŠ ä¸Šä»¥ä¸‹é…ç½®ï¼Œè¦†ç›–ribboné»˜è®¤é…ç½®

```yaml

ribbon :
  #retry next Server times
  MaxAutoRetriesNextServer : 0
  #retry same Server times
  MaxAutoRetries : 0
  ReadTimeout : 20000
  ConnectTimeout : 5000

```

+   åœ¨Feign client ä¸­ä½¿ç”¨@PathVariableï¼Œ@RequestParam æ³¨è§£ï¼Œå¿…é¡»æŒ‡å®švalueå€¼,  ```å¦åˆ™ä¼šæŠ¥ï¼šjava.lang.IllegalStateException: PathVariable annotation was empty on param 0. ```

```java

@GetMapping(value = "/user/{id}")  
User findById(@PathVariable("id") Long id);  

```

+   å…³äºGETè¯·æ±‚å‚æ•°ç»‘å®šä¸æ”¯æŒGenericDTO<T>

>
>   **åŸå› ï¼š**
>
>   1, feign å¯¹è±¡GETè¯·æ±‚ä¹Ÿæ˜¯ç”¨Jsonå‘é€
>
>

è§£å†³æ–¹æ³•ä¸€ï¼šå‚æ•°ç»§æ‰¿```GenericDTO<NoBody>``` ï¼Œ GenericDTOæˆ–å…¶å­ç±» å¿…é¡» @QueryBodyæ³¨è§£
```java
        @GetMapping("/findUser2")
    public GenericRspDTO<List<User>> findUser2(@Validated @QueryBody UserQueryDTO queryUserDTO) {
        List<User> users = null;
        //çœç•¥
        return GenericRspDTO.newSuccessInstance(users);
    }
    
    @ClientValidated
    @ApiModel(value="UserQueryDTO", description="ç”¨æˆ·æŸ¥è¯¢ä¼ è¾“å¯¹è±¡")
    public class UserQueryDTO extends GenericDTO<NoBody>{
        @ApiModelProperty(value="å§“å", required= true)
        @NotEmpty(message="DM310001")
        private String name;
    }
```

è§£å†³æ–¹æ³•äºŒ: å¤šä¸ªå‚æ•°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªä¸º```GenericDTO<NoBody>``` ;GenericDTO å¿…é¡» @QueryBodyæ³¨è§£ å½“å‚æ•°æ¯”è¾ƒå›ºå®šçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¯¥æ–¹æ¡ˆ
```java
    @GetMapping("/findUser3")
    public GenericRspDTO<List<User>> findUser3(@RequestParam String name, @RequestParam int pageNum, 
        @RequestParam int pageSize, @QueryBody GenericDTO<NoBody> genericDTO) {
        List<User> users = null;
        //çœç•¥
        return GenericRspDTO.newSuccessInstance(users);
    }
```

feign æ¥å£ä¹Ÿéœ€è¦@QueryBodyæ³¨è§£

```java

    @GetMapping("/user/findUser2")
    public GenericRspDTO<List<UserQueryDTO.User>> findUser2(@QueryBody UserQueryDTO userQueryDTO);
    

    @GetMapping("/user/findUser3")
    public GenericRspDTO<List<UserQueryDTO.User>> findUser3(@RequestParam("name") String name, @RequestParam("pageSize") Integer pageSize, @RequestParam("pageNum") Integer pageNum, @Validated @QueryBody GenericDTO<NoBody> genericDTO);
    

```

---------------------------------------

##  mybatis ä»£ç è‡ªåŠ¨ç”Ÿæˆ

+   mybatis ä»£ç è‡ªåŠ¨ç”Ÿæˆæ˜¯æ ¹æ®mybatis-generatorä¿®æ”¹è€Œæˆï¼Œè§é¡¹ç›® [lemon-generator](/lemon-generator)


1. ä¿®æ”¹é…ç½®æ–‡ä»¶    [generatorConfig.xml](/lemon-generator/generatorConfig.xml)

   ä¿®æ”¹æ•°æ®åº“å‚æ•°  **connectionURL** 

   ```xml
   <jdbcConnection driverClass="com.mysql.jdbc.Driver" connectionURL="jdbc:mysql://localhost:3306/seatelpay" userId="seatelpay" password="seatelpay">  
   </jdbcConnection>
   ```

    ä¿®æ”¹ç”Ÿæˆæ–‡ä»¶å­˜æ”¾ç›®å½•    **targetProject**   åŠå·¥ç¨‹ç›®å½•ç»“æ„  **targetPackage**  ï¼Œå…¶ä»–é…ç½®éƒ½ä¸è¦ä¿®æ”¹

   ```xml
   <context id="user"  targetRuntime="MyBatis3" defaultModelType="lemonflat">
       <javaModelGenerator targetPackage="com.cmpay.user.entity" targetProject="src/main/java">
           <property name="enableSubPackages" value="false"/>  
           <property name="trimStrings" value="false"/>
           <property name="rootClass" value="com.cmpay.framework.data.BaseDO"/>
       </javaModelGenerator>  
               
       <sqlMapGenerator targetPackage="com.cmpay.user.mapper" targetProject="src/main/resources">
           <property name="enableSubPackages" value="false"/>
       </sqlMapGenerator>
       
       <javaClientGenerator type="XMLMAPPER" targetPackage="com.cmpay.user.dao" targetProject="src/main/java">
           <property name="enableSubPackages" value="false"/>
       </javaClientGenerator>
   </context> 
   ```

   å¢åŠ éœ€è¦è‡ªåŠ¨ç”Ÿäº§mybatisçš„TABLEé…ç½®
   ```xml
   <context id="user"  targetRuntime="MyBatis3" defaultModelType="lemonflat">
       <table tableName="LEMON_USER" domainObjectName="UserDO" enableCountByExample="false" enableUpdateByExample="false"
                  enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false">
           <columnOverride column="sex" javaType="com.cmpay.user.common.Sex" jdbcType="VARCHAR" />
           <columnOverride column="birthday" javaType="java.time.LocalDate" jdbcType="TIMESTAMP" />
       </table>
   </context> 
   ```

2. è¿è¡Œ gradle lemon æ’ä»¶ mybatisGen


3. ç”Ÿæˆä»£ç æ•ˆæœå¦‚ä¸‹

  dao, æ‰©å±•çš„æ–¹æ³•åœ¨æ­¤æ¥å£ä¸­å®šä¹‰

    ```java
    â€‹    package com.cmpay.user.dao;
         
         import com.cmpay.lemon.framework.dao.BaseDao;
         import com.cmpay.user.entity.UserDO;
         import org.apache.ibatis.annotations.Mapper;
         
         @Mapper
         public interface IUserDao extends BaseDao<UserDO, String> {
          
         }
    ```
  
  java entity
  
    ```java
        package com.cmpay.user.entity;
        
        import com.cmpay.framework.data.BaseDO;
        import com.cmpay.lemon.framework.annotation.DataObject;
        import com.cmpay.lemon.framework.id.GeneratedValue;
        import com.cmpay.user.common.Sex;
        
        import java.time.LocalDate;
        
        @DataObject
        public class UserDO extends BaseDO {
            /**
             * @Fields userId 
             */
            @GeneratedValue(prefix = "U", key = "USER_ID")
            private String userId;
            //.....çœç•¥
        }
    
    ```
  
  xml mapper
  â€‹      
    ```xml
    
    ```

## é™„å½•

### å¿½ç•¥DTOå±æ€§ç”Ÿæˆå“åº”æŠ¥æ–‡

- [@ResponseIgnore](/lemon-framework-core/src/main/java/com/cmpay/lemon/framework/annotation/ResponseIgnore.java)æ³¨è§£

> ç”¨äºæ³¨è§£åœ¨æ¸ é“åº”ç”¨åŠæ¥å‡ºç½‘å…³Response DTOå±æ€§ä¸Šï¼Œè¢«æ³¨è§£çš„å±æ€§ä¸ä¼šç”Ÿæˆå“åº”æŠ¥æ–‡ã€‚ä¾‹å¦‚æ¡†æ¶å†…éƒ¨ä½¿ç”¨çš„â€œä¼šè®¡æ—¥æœŸâ€ã€â€œGWAâ€ç­‰ã€‚

ç¤ºä¾‹

```java
public abstract class BaseLemonData {
    /**
     * äº¤æ˜“æµæ°´å·ï¼Œåªä»£è¡¨ä¸€æ¬¡äº¤æ˜“ï¼Œè¯·æ±‚å’Œè¿”å›DTOå¯¹è±¡msgIDä¸€è‡´
     */
    @ResponseIgnore
    @ApiModelProperty(hidden = true)
    private String msgId;
    /**
     * äº¤æ˜“å‘èµ·æ—¶é—´
     */
    @ResponseIgnore
    @ApiModelProperty(hidden = true)
    private LocalDateTime startDateTime;
}
```





### æšä¸¾ç±»å‹

æ”¯æŒSpring mvcä¸­åºåˆ—åŒ–åŠååºåˆ—åŒ–ã€MVCæ•°æ®ç»‘å®šã€mybatis type handlerã€ICSæ¥å£åºåˆ—åŒ–åŠååºåˆ—åŒ–

- ç®€å•enumç±»å‹

  ```java
  public enum Sex {
      //åºåˆ—åŒ–ã€ååºåˆ—åŒ–çš„å€¼ä¸ºMALEã€FEMALE
      MALE, FEMALE;
  }
  
  @Data
  public static class Student {
      private String name;
      private Sex sex;
  }
  ```

  

- å®ç°[Valuableæ¥å£](/lemon-framework-core/src/main/java/com/cmpay/lemon/framework/valuable.Valuable)çš„enum


```java
public enum Sex implements Valuable<String> {
  	//åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å€¼ä¸ºâ€œç”·â€ã€"å¥³"
    MALE("ç”·"), FEMALE("å¥³");

    private String value;

    Sex(String value) {
        this.value = value;
    }

    @Override
    public String getValue() {
        return this.value;
    }
}

@Data
public static class Student {
    private String name;
    private Sex sex;
}
```

